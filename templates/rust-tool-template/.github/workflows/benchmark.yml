name: Benchmark

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'benches/**'
      - 'Cargo.toml'
  workflow_dispatch:  # Allow manual trigger

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  benchmark:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust-version: [stable, beta]
      fail-fast: false  # Run all matrix jobs even if one fails

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust ${{ matrix.rust-version }}
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ matrix.rust-version }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ matrix.rust-version }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Run benchmarks
        id: bench
        run: |
          cargo bench --bench benchmark -- --noplot 2>&1 | tee benchmark-output.txt
          # Extract JSON results if using criterion
          if [ -d target/criterion ]; then
            find target/criterion -name "estimates.json" -exec cat {} \; > benchmark-results.json
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-rust-${{ matrix.rust-version }}
          path: |
            benchmark-output.txt
            benchmark-results.json
          retention-days: 90

  # Summary job - runs after all matrix jobs and posts a single PR comment
  comment:
    needs: benchmark
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all benchmark artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: benchmark-results-rust-*
          path: results/
        continue-on-error: true

      - name: Generate summary
        id: summary
        run: |
          echo "## üìä Benchmark Results (Rust)" > summary.md
          echo "" >> summary.md

          OVERALL_STATUS="${{ needs.benchmark.result }}"
          if [ "$OVERALL_STATUS" = "success" ]; then
            echo "**Status:** ‚úÖ All benchmarks passed" >> summary.md
          elif [ "$OVERALL_STATUS" = "failure" ]; then
            echo "**Status:** ‚ùå Some benchmarks failed" >> summary.md
          else
            echo "**Status:** ‚ö†Ô∏è Benchmark run incomplete" >> summary.md
          fi

          echo "" >> summary.md
          echo "### Results by Rust Version" >> summary.md
          echo "" >> summary.md
          echo "| Rust | Status |" >> summary.md
          echo "|------|--------|" >> summary.md

          for dir in results/benchmark-results-rust-*/; do
            if [ -d "$dir" ]; then
              version=$(echo "$dir" | grep -oP 'rust-\K[^/]+')
              if [ -f "$dir/benchmark-output.txt" ]; then
                echo "| $version | ‚úÖ |" >> summary.md
              else
                echo "| $version | ‚ö†Ô∏è Missing |" >> summary.md
              fi
            fi
          done

          echo "" >> summary.md
          echo "_Generated by [Benchmark CI](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_" >> summary.md

          {
            echo 'summary<<EOF'
            cat summary.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.summary.outputs.summary }}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.body.includes('## üìä Benchmark Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

      - name: Send Slack notification
        if: always() && env.TUULBELT_SLACK_WEBHOOK != ''
        env:
          TUULBELT_SLACK_WEBHOOK: ${{ secrets.TUULBELT_SLACK_WEBHOOK }}
        run: |
          OVERALL_STATUS="${{ needs.benchmark.result }}"
          if [ "$OVERALL_STATUS" = "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="All benchmarks passed"
            COLOR="good"
          elif [ "$OVERALL_STATUS" = "failure" ]; then
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="Benchmark failed"
            COLOR="danger"
          else
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="Benchmark incomplete"
            COLOR="warning"
          fi

          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Convert repo name to Title Case
          REPO_NAME="${{ github.event.repository.name }}"
          TOOL_NAME=$(echo "$REPO_NAME" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')

          curl -X POST "$TUULBELT_SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"blocks\": [
                  {
                    \"type\": \"header\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"$STATUS_EMOJI $TOOL_NAME Benchmark (Rust)\"
                    }
                  },
                  {
                    \"type\": \"section\",
                    \"fields\": [
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*Status:*\n$STATUS_TEXT\"
                      },
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*PR:*\n<$PR_URL|$PR_TITLE>\"
                      }
                    ]
                  },
                  {
                    \"type\": \"actions\",
                    \"elements\": [
                      {
                        \"type\": \"button\",
                        \"text\": {
                          \"type\": \"plain_text\",
                          \"text\": \"View Workflow Run\"
                        },
                        \"url\": \"$RUN_URL\"
                      }
                    ]
                  }
                ]
              }]
            }"
