name: Benchmark

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'benchmarks/**'
      - 'package.json'
  workflow_dispatch:  # Allow manual trigger

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  benchmark:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
      fail-fast: false  # Run all matrix jobs even if one fails

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run benchmarks
        id: bench
        run: |
          npm run --silent bench:ci > benchmark-results.json
          echo "Benchmark results:"
          cat benchmark-results.json

      - name: Compare against baseline
        id: compare
        run: |
          npm run --silent bench:compare < benchmark-results.json
        continue-on-error: true  # Don't fail workflow yet, capture result

      - name: Set comparison result
        id: result
        run: |
          if [ "${{ steps.compare.outcome }}" == "failure" ]; then
            echo "regression=true" >> $GITHUB_OUTPUT
            echo "status=âŒ REGRESSION DETECTED" >> $GITHUB_OUTPUT
          else
            echo "regression=false" >> $GITHUB_OUTPUT
            echo "status=âœ… No regressions" >> $GITHUB_OUTPUT
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-node-${{ matrix.node-version }}
          path: benchmark-results.json
          retention-days: 90  # Extended for historical tracking

      - name: Fail if regression detected
        if: steps.compare.outcome == 'failure'
        run: |
          echo "Performance regression detected!"
          exit 1

  # Summary job - runs after all matrix jobs and posts a single PR comment
  comment:
    needs: benchmark
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'  # Run even if benchmark jobs fail
    permissions:
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all benchmark artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: benchmark-results-node-*
          path: results/
        continue-on-error: true  # Continue even if some artifacts missing

      - name: Generate summary
        id: summary
        run: |
          echo "## ðŸ“Š Benchmark Results" > summary.md
          echo "" >> summary.md

          # Overall status based on matrix job outcomes
          OVERALL_STATUS="${{ needs.benchmark.result }}"
          if [ "$OVERALL_STATUS" = "success" ]; then
            echo "**Status:** âœ… All benchmarks passed" >> summary.md
          elif [ "$OVERALL_STATUS" = "failure" ]; then
            echo "**Status:** âŒ Some benchmarks failed (regression detected)" >> summary.md
          else
            echo "**Status:** âš ï¸ Benchmark run incomplete" >> summary.md
          fi

          echo "" >> summary.md
          echo "### Results by Node Version" >> summary.md
          echo "" >> summary.md
          echo "| Node | Status | Key Metrics |" >> summary.md
          echo "|------|--------|-------------|" >> summary.md

          for dir in results/benchmark-results-node-*/; do
            if [ -d "$dir" ]; then
              version=$(echo "$dir" | grep -oP 'node-\K\d+')
              if [ -f "$dir/benchmark-results.json" ]; then
                # Extract a few key metrics from results (simple approach)
                echo "| $version | âœ… | See [artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> summary.md
              else
                echo "| $version | âš ï¸ Missing | - |" >> summary.md
              fi
            fi
          done

          echo "" >> summary.md
          echo "<details>" >> summary.md
          echo "<summary>View baseline comparison details</summary>" >> summary.md
          echo "" >> summary.md
          echo "Baseline thresholds:" >> summary.md
          echo "- Regression threshold: >15% slower" >> summary.md
          echo "- Improvement threshold: >10% faster" >> summary.md
          echo "" >> summary.md
          echo "</details>" >> summary.md
          echo "" >> summary.md
          echo "_Generated by [Benchmark CI](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_" >> summary.md

          # Store summary for the comment
          {
            echo 'summary<<EOF'
            cat summary.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.summary.outputs.summary }}`;

            // Find existing benchmark comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.body.includes('## ðŸ“Š Benchmark Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

      - name: Send Slack notification
        if: always() && env.TUULBELT_SLACK_WEBHOOK != ''
        env:
          TUULBELT_SLACK_WEBHOOK: ${{ secrets.TUULBELT_SLACK_WEBHOOK }}
        run: |
          OVERALL_STATUS="${{ needs.benchmark.result }}"
          if [ "$OVERALL_STATUS" = "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="All benchmarks passed"
            COLOR="good"
          elif [ "$OVERALL_STATUS" = "failure" ]; then
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="Regression detected!"
            COLOR="danger"
          else
            STATUS_EMOJI="âš ï¸"
            STATUS_TEXT="Benchmark incomplete"
            COLOR="warning"
          fi

          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Convert repo name to Title Case (e.g., "property-validator" -> "Property Validator")
          REPO_NAME="${{ github.event.repository.name }}"
          TOOL_NAME=$(echo "$REPO_NAME" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')

          curl -X POST "$TUULBELT_SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"blocks\": [
                  {
                    \"type\": \"header\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"$STATUS_EMOJI $TOOL_NAME Benchmark\"
                    }
                  },
                  {
                    \"type\": \"section\",
                    \"fields\": [
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*Status:*\n$STATUS_TEXT\"
                      },
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*PR:*\n<$PR_URL|$PR_TITLE>\"
                      }
                    ]
                  },
                  {
                    \"type\": \"actions\",
                    \"elements\": [
                      {
                        \"type\": \"button\",
                        \"text\": {
                          \"type\": \"plain_text\",
                          \"text\": \"View Workflow Run\"
                        },
                        \"url\": \"$RUN_URL\"
                      }
                    ]
                  }
                ]
              }]
            }"
