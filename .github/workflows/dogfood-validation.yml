name: Dogfood Validation

on:
  # Trigger after Test All Tools workflow completes successfully
  workflow_run:
    workflows: ["Test All Tools"]
    types:
      - completed
    branches:
      - main
  push:
    branches:
      - main
    paths:
      # Trigger on dogfood script changes
      - '**/scripts/dogfood*.sh'
      - '**/DOGFOODING_STRATEGY.md'
  pull_request:
    branches:
      - main
    paths:
      - '**/scripts/dogfood*.sh'
      - '**/DOGFOODING_STRATEGY.md'
  schedule:
    # Run weekly on Sunday at 3 AM UTC (after nightly tests)
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      tool:
        description: 'Specific tool to validate (leave empty for all)'
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Build all tools first (dogfood scripts have cross-tool dependencies)
  build-tools:
    name: Build All Tools
    runs-on: ubuntu-latest
    # Skip if triggered by workflow_run and the triggering workflow failed
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            file-based-semaphore -> target
            output-diffing-utility -> target
            snapshot-comparison -> target

      # Build TypeScript tools and link CLIs
      - name: Build and link TypeScript tools
        run: |
          for dir in test-flakiness-detector cli-progress-reporting cross-platform-path-normalizer \
                     config-file-merger structured-error-handler file-based-semaphore-ts; do
            if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
              echo "Building $dir..."
              cd "$dir"
              npm ci
              npm run build
              npm link 2>/dev/null || true
              cd ..
            fi
          done

      # Build Rust tools
      - name: Build Rust tools
        run: |
          for dir in file-based-semaphore output-diffing-utility snapshot-comparison; do
            if [ -d "$dir" ] && [ -f "$dir/Cargo.toml" ]; then
              echo "Building $dir..."
              cd "$dir"
              cargo build --release
              cd ..
            fi
          done

      # Cache built artifacts for dogfood jobs
      - name: Upload built tools
        uses: actions/upload-artifact@v4
        with:
          name: built-tools
          path: |
            */target/release/*
            */node_modules
            */dist
          retention-days: 1

  # Discover tools with dogfood scripts
  discover-dogfood:
    name: Discover Dogfood Scripts
    runs-on: ubuntu-latest
    outputs:
      tools: ${{ steps.find.outputs.tools }}
      count: ${{ steps.find.outputs.count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find tools with dogfood scripts
        id: find
        run: |
          # Find all directories containing dogfood scripts
          TOOLS=$(find . -path "*/scripts/dogfood*.sh" -type f | \
                  xargs -I {} dirname {} | \
                  xargs -I {} dirname {} | \
                  sed 's|^\./||' | \
                  sort -u | \
                  grep -v "^templates" || echo "")

          if [ -n "$TOOLS" ]; then
            # Filter by specific tool if provided
            if [ -n "${{ inputs.tool }}" ]; then
              TOOLS=$(echo "$TOOLS" | grep "${{ inputs.tool }}" || echo "")
            fi

            TOOLS_JSON=$(echo "$TOOLS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            COUNT=$(echo "$TOOLS_JSON" | jq 'length')
          else
            TOOLS_JSON="[]"
            COUNT=0
          fi

          echo "tools=$TOOLS_JSON" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Found $COUNT tools with dogfood scripts: $TOOLS"

  # Run dogfood validation for each tool
  validate-dogfood:
    name: Validate ${{ matrix.tool }}
    needs: [build-tools, discover-dogfood]
    if: needs.discover-dogfood.outputs.tools != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tool: ${{ fromJson(needs.discover-dogfood.outputs.tools) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download built tools
        uses: actions/download-artifact@v4
        with:
          name: built-tools
          path: .

      # Rebuild and link CLIs (artifacts don't preserve symlinks)
      - name: Setup CLI tools
        run: |
          # Link TypeScript CLIs
          for dir in test-flakiness-detector cli-progress-reporting cross-platform-path-normalizer \
                     config-file-merger structured-error-handler file-based-semaphore-ts; do
            if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
              cd "$dir"
              npm link 2>/dev/null || true
              cd ..
            fi
          done

      - name: Run dogfood scripts for ${{ matrix.tool }}
        id: dogfood
        working-directory: ${{ matrix.tool }}
        run: |
          echo "## Dogfood Validation: ${{ matrix.tool }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SCRIPTS=$(find scripts -name "dogfood*.sh" -type f 2>/dev/null | sort)
          PASSED=0
          FAILED=0
          SKIPPED=0

          for script in $SCRIPTS; do
            SCRIPT_NAME=$(basename "$script")
            echo "Running $SCRIPT_NAME..."
            echo "### $SCRIPT_NAME" >> $GITHUB_STEP_SUMMARY

            if timeout 300 bash "$script" 2>&1; then
              echo "âœ… $SCRIPT_NAME passed"
              echo "âœ… Passed" >> $GITHUB_STEP_SUMMARY
              PASSED=$((PASSED + 1))
            else
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 124 ]; then
                echo "â±ï¸ $SCRIPT_NAME timed out"
                echo "â±ï¸ Timed out (5 min limit)" >> $GITHUB_STEP_SUMMARY
                SKIPPED=$((SKIPPED + 1))
              elif [ $EXIT_CODE -eq 0 ]; then
                # Script exited gracefully (e.g., not in monorepo context)
                echo "â­ï¸ $SCRIPT_NAME skipped (graceful exit)"
                echo "â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
                SKIPPED=$((SKIPPED + 1))
              else
                echo "âŒ $SCRIPT_NAME failed with exit code $EXIT_CODE"
                echo "âŒ Failed (exit $EXIT_CODE)" >> $GITHUB_STEP_SUMMARY
                FAILED=$((FAILED + 1))
              fi
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** $PASSED passed, $FAILED failed, $SKIPPED skipped" >> $GITHUB_STEP_SUMMARY

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

          # Fail if any dogfood script failed
          if [ $FAILED -gt 0 ]; then
            echo "::error::$FAILED dogfood script(s) failed for ${{ matrix.tool }}"
            exit 1
          fi

      - name: Save result
        if: always()
        run: |
          mkdir -p results
          cat > results/${{ matrix.tool }}.json << EOF
          {
            "tool": "${{ matrix.tool }}",
            "passed": ${{ steps.dogfood.outputs.passed || 0 }},
            "failed": ${{ steps.dogfood.outputs.failed || 0 }},
            "skipped": ${{ steps.dogfood.outputs.skipped || 0 }},
            "status": "${{ job.status }}"
          }
          EOF

      - name: Upload result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dogfood-result-${{ matrix.tool }}
          path: results/${{ matrix.tool }}.json
          retention-days: 7

  # Summary job
  summary:
    name: Dogfood Summary
    needs: [discover-dogfood, validate-dogfood]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: dogfood-result-*
          path: results
          merge-multiple: true

      - name: Create summary
        run: |
          echo "## ðŸ• Dogfood Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tools validated:** ${{ needs.discover-dogfood.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL_PASSED=0
          TOTAL_FAILED=0

          echo "| Tool | Passed | Failed | Skipped | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|--------|---------|--------|" >> $GITHUB_STEP_SUMMARY

          for file in results/*.json; do
            if [ -f "$file" ]; then
              TOOL=$(jq -r '.tool' "$file")
              PASSED=$(jq -r '.passed' "$file")
              FAILED=$(jq -r '.failed' "$file")
              SKIPPED=$(jq -r '.skipped' "$file")
              STATUS=$(jq -r '.status' "$file")

              if [ "$STATUS" = "success" ]; then
                ICON="âœ…"
              else
                ICON="âŒ"
              fi

              echo "| $TOOL | $PASSED | $FAILED | $SKIPPED | $ICON |" >> $GITHUB_STEP_SUMMARY

              TOTAL_PASSED=$((TOTAL_PASSED + PASSED))
              TOTAL_FAILED=$((TOTAL_FAILED + FAILED))
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total:** $TOTAL_PASSED scripts passed, $TOTAL_FAILED failed" >> $GITHUB_STEP_SUMMARY

          if [ $TOTAL_FAILED -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Some dogfood validations failed. Check individual job logs." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
