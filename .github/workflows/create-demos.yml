name: Create Demo Recordings

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/record-*-demo.sh'
      - '.github/workflows/create-demos.yml'
  workflow_dispatch:  # Manual trigger
    inputs:
      tool:
        description: 'Tool to record demo for (leave empty for all tools)'
        required: false
        type: string

jobs:
  create-demos:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install asciinema
        run: |
          sudo apt-get update
          sudo apt-get install -y asciinema

      - name: Install agg (asciinema GIF generator)
        run: |
          cargo install --git https://github.com/asciinema/agg

      - name: Discover and record demos
        env:
          ASCIINEMA_API_TOKEN: ${{ secrets.ASCIINEMA_API_TOKEN }}
          TARGET_TOOL: ${{ github.event.inputs.tool }}
        run: |
          # Find all tools with demo recording scripts
          if [ -n "$TARGET_TOOL" ]; then
            # Record specific tool
            TOOLS=("$TARGET_TOOL")
          else
            # Auto-discover all tools with recording scripts
            TOOLS=()
            for script in scripts/record-*-demo.sh; do
              if [ -f "$script" ]; then
                # Extract tool name from script filename
                tool=$(basename "$script" | sed 's/^record-//' | sed 's/-demo\.sh$//')
                TOOLS+=("$tool")
              fi
            done
          fi

          echo "Found ${#TOOLS[@]} tool(s) to record:"
          printf '%s\n' "${TOOLS[@]}"

          # Record demos for each tool
          for tool in "${TOOLS[@]}"; do
            echo "================================"
            echo "Recording demo for: $tool"
            echo "================================"

            # Install dependencies if package.json exists
            if [ -f "$tool/package.json" ]; then
              echo "Installing npm dependencies for $tool..."
              cd "$tool"
              npm install
              cd ..
            fi

            # Run the recording script
            if [ -f "scripts/record-${tool}-demo.sh" ]; then
              cd "$tool"
              bash "../scripts/record-${tool}-demo.sh"
              cd ..
            else
              echo "Warning: No recording script found for $tool"
            fi
          done

      - name: Copy demos to VitePress public directory
        run: |
          # Copy demo GIFs to VitePress public directory for GitHub Pages
          for tool_dir in */; do
            tool_dir=${tool_dir%/}

            if [ -f "$tool_dir/docs/demo.gif" ]; then
              mkdir -p "docs/public/$tool_dir"
              cp "$tool_dir/docs/demo.gif" "docs/public/$tool_dir/demo.gif"
              echo "✓ Copied demo to docs/public/$tool_dir/demo.gif"
            fi
          done

      - name: Update READMEs with demo embeds
        run: |
          # Update each tool's README with embedded GIF and asciinema link
          for tool_dir in */; do
            tool_dir=${tool_dir%/}  # Remove trailing slash

            # Skip if not a tool directory
            if [ ! -f "$tool_dir/README.md" ]; then
              continue
            fi

            # Skip if no demo files
            if [ ! -f "$tool_dir/docs/demo.gif" ]; then
              continue
            fi

            echo "Updating README for $tool_dir..."

            # Get asciinema URL if available
            ASCIINEMA_URL="#"
            if [ -f "$tool_dir/demo-url.txt" ]; then
              ASCIINEMA_URL=$(cat "$tool_dir/demo-url.txt" | tr -d '\n')
            fi

            # Update README Demo section
            # Replace placeholder with embedded GIF and real asciinema link
            if grep -q "## Demo" "$tool_dir/README.md"; then
              # Create updated demo section
              cat > /tmp/demo-section.md << EOF
## Demo

![Demo](docs/demo.gif)

**[▶ View interactive recording on asciinema.org]($ASCIINEMA_URL)**

> Try it online: [![Open in StackBlitz](https://developer.stackblitz.com/img/open_in_stackblitz.svg)](https://stackblitz.com/github/tuulbelt/tuulbelt/tree/main/$tool_dir)
EOF

              # Replace Demo section in README (from ## Demo to next ##)
              awk '/^## Demo$/{p=1} p{if(/^## / && !/^## Demo$/){p=0}} !p' "$tool_dir/README.md" > /tmp/readme-without-demo.md

              # Find where to insert (before ## License)
              awk '/^## License$/{print "";system("cat /tmp/demo-section.md");print ""} {print}' /tmp/readme-without-demo.md > "$tool_dir/README.md.new"

              mv "$tool_dir/README.md.new" "$tool_dir/README.md"

              echo "✓ Updated README for $tool_dir"
            fi
          done

      - name: Commit demo files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add all demo-related files including updated READMEs and VitePress public directory
          git add "*/demo.cast" "*/docs/demo.gif" "*/demo-url.txt" "*/README.md" "docs/public/*/demo.gif" || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update demo recordings and embed in READMEs [skip ci]"
            git push
          fi
