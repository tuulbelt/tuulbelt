name: Update Quality Dashboard

on:
  workflow_run:
    workflows: ["Test All Tools"]
    types:
      - completed
    branches:
      - main
  schedule:
    # Run daily at 3 AM UTC (after nightly tests)
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Allow manual trigger

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: read

jobs:
  update-dashboard:
    name: Update Dashboard
    runs-on: ubuntu-latest
    # Run if test-all-tools completed (success or failure) OR if manually/scheduled
    # Skip if triggered by the bot's own commits to prevent infinite loops
    if: |
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion != 'cancelled') &&
      (github.event_name != 'workflow_run' || github.event.workflow_run.head_commit.author.name != 'github-actions[bot]')
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.TUULBELT_BOT_APP_ID }}
          private-key: ${{ secrets.TUULBELT_BOT_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: true

      - name: Download test results (from triggering workflow)
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: .
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Download test results (from latest workflow run)
        if: github.event_name != 'workflow_run'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find the most recent successful test-all-tools run
          RUN_ID=$(gh run list --workflow="Test All Tools" --status=success --limit=1 --json databaseId --jq '.[0].databaseId')

          if [ -n "$RUN_ID" ]; then
            echo "Downloading artifact from run $RUN_ID"
            gh run download "$RUN_ID" --name test-results --dir . || echo "No artifact found"
          else
            echo "No successful test run found"
          fi

      - name: Generate dashboard from results
        id: generate
        run: |
          mkdir -p docs

          # Check if we have test results
          if [ -f "test-results.json" ]; then
            echo "Using test results from artifact"

            # Parse the JSON and generate dashboard
            TIMESTAMP=$(jq -r '.timestamp' test-results.json)
            TOOL_COUNT=$(jq '.results | length' test-results.json)
            PASSING=$(jq '[.results[] | select(.status == "success")] | length' test-results.json)
            FAILING=$(jq '[.results[] | select(.status != "success")] | length' test-results.json)

            # Generate dashboard header
            cat > docs/TOOL_DASHBOARD.md << EOF
          # Tuulbelt Tool Quality Dashboard

          **Last Updated:** $(date -u +"%Y-%m-%d %H:%M UTC")
          **Test Results From:** ${TIMESTAMP}
          **Total Tools:** ${TOOL_COUNT}
          **Passing:** ${PASSING} | **Failing:** ${FAILING}

          ---

          ## Tool Status

          | Tool | Language | Tests | Build | Status | Version |
          |------|----------|-------|-------|--------|---------|
          EOF

            # Generate table rows from JSON
            jq -r '.results[] |
              (if .status == "success" then "ðŸŸ¢ Production" else "ðŸ”´ Broken" end) as $status |
              (if .build == "success" then "âœ…" else "âŒ" end) as $build |
              "| \(.tool) | \(.language) | \(.testCount) | \($build) | \($status) | \(.version) |"
            ' test-results.json >> docs/TOOL_DASHBOARD.md

          else
            echo "No test results found, generating placeholder dashboard"
            TOOL_COUNT=0
            PASSING=0
            FAILING=0

            cat > docs/TOOL_DASHBOARD.md << EOF
          # Tuulbelt Tool Quality Dashboard

          **Last Updated:** $(date -u +"%Y-%m-%d %H:%M UTC")
          **Status:** âš ï¸ No test results available

          Run the "Test All Tools" workflow to generate test results.

          ---

          ## Tool Status

          | Tool | Language | Tests | Build | Status | Version |
          |------|----------|-------|-------|--------|---------|
          | *No data* | - | - | - | - | - |
          EOF
          fi

          # Add footer
          cat >> docs/TOOL_DASHBOARD.md << 'EOF'

          ---

          ## Status Legend

          - ðŸŸ¢ **Production** - All tests passing, build successful
          - ðŸŸ¡ **In Development** - Work in progress
          - ðŸ”´ **Broken** - Tests failing or build broken
          - âšª **Not Started** - Planned but not implemented

          ---

          ## How This Works

          1. **Test All Tools** workflow runs tests and uploads results as artifact
          2. **Update Dashboard** workflow downloads results and generates this page
          3. No tests are re-run - dashboard is generated from cached results

          ---

          *This dashboard is auto-generated. Do not edit manually.*
          EOF

          echo "tool-count=$TOOL_COUNT" >> $GITHUB_OUTPUT
          echo "passing-count=$PASSING" >> $GITHUB_OUTPUT
          echo "failing-count=$FAILING" >> $GITHUB_OUTPUT

      - name: Commit dashboard updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/TOOL_DASHBOARD.md

          if git diff --staged --quiet; then
            echo "No changes to dashboard"
          else
            git commit -m "docs: update tool quality dashboard

          Tools: ${{ steps.generate.outputs.tool-count }}
          Passing: ${{ steps.generate.outputs.passing-count }}
          Failing: ${{ steps.generate.outputs.failing-count }}

          Auto-generated by update-dashboard workflow (from test-all-tools artifact)"
            git push
          fi

      - name: Create summary
        run: |
          echo "## Quality Dashboard Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tools:** ${{ steps.generate.outputs.tool-count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Passing:** ${{ steps.generate.outputs.passing-count }} âœ…" >> $GITHUB_STEP_SUMMARY
          echo "**Failing:** ${{ steps.generate.outputs.failing-count }} âŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Generated from test-all-tools artifact (no re-testing)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Dashboard: [docs/TOOL_DASHBOARD.md](https://github.com/${{ github.repository }}/blob/main/docs/TOOL_DASHBOARD.md)" >> $GITHUB_STEP_SUMMARY
