name: Update Demo Outputs

on:
  push:
    branches:
      - main
    paths:
      - 'test-flakiness-detector/src/**'
  schedule:
    # Update demos weekly on Sundays at 4 AM UTC
    - cron: '0 4 * * 0'
  workflow_dispatch:
    # Allow manual trigger

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  generate-demos:
    name: Generate Demo Outputs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: test-flakiness-detector
        run: npm ci

      - name: Generate demo outputs
        working-directory: test-flakiness-detector
        run: |
          mkdir -p examples/outputs

          echo "Generating all-pass example..."
          npx flaky --test "echo 'test passed'" --runs 5 > examples/outputs/all-pass.json 2>&1 || true

          echo "Generating all-fail example..."
          npx flaky --test "exit 1" --runs 3 > examples/outputs/all-fail.json 2>&1 || true

          echo "Generating flaky test example..."
          npx flaky --test 'node -e "process.exit(Math.random() > 0.5 ? 0 : 1)"' --runs 20 > examples/outputs/flaky-detected.json 2>&1 || true

          echo "Generating verbose mode example..."
          npx flaky --test "echo 'test'" --runs 3 --verbose > examples/outputs/verbose-mode.txt 2>&1 || true

      - name: Verify outputs were generated
        working-directory: test-flakiness-detector
        run: |
          ls -lh examples/outputs/
          echo "Demo files generated:"
          for file in examples/outputs/*; do
            echo "  - $(basename $file) ($(wc -c < $file) bytes)"
          done

      - name: Commit updated demos
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add test-flakiness-detector/examples/outputs/

          if git diff --staged --quiet; then
            echo "No changes to demo outputs"
          else
            git commit -m "$(cat <<'EOF'
          docs(demos): update example outputs

          Auto-generated demo files:
          - all-pass.json: Example with all tests passing
          - all-fail.json: Example with all tests failing
          - flaky-detected.json: Example with flaky tests detected
          - verbose-mode.txt: Example with verbose output

          Generated by update-demos workflow
          EOF
          )"
            git push
          fi

      - name: Create summary
        run: |
          echo "## Demo Outputs Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated demo files:" >> $GITHUB_STEP_SUMMARY
          echo "- \`all-pass.json\` - All tests passing" >> $GITHUB_STEP_SUMMARY
          echo "- \`all-fail.json\` - All tests failing" >> $GITHUB_STEP_SUMMARY
          echo "- \`flaky-detected.json\` - Flaky tests detected" >> $GITHUB_STEP_SUMMARY
          echo "- \`verbose-mode.txt\` - Verbose output example" >> $GITHUB_STEP_SUMMARY
